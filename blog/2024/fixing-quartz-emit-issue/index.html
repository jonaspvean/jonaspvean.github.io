<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Fixing the Quartz Emit Issue | Jonas Pedersen Vean </title> <meta name="author" content="Jonas Pedersen Vean"> <meta name="description" content="The joys and power of a makeshift solution"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/faviconmathscrPnew.png?0d6128554121adeea0c7cfd4ced12b08"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="stylesheet" href="/assets/css/custom.css"> <link rel="canonical" href="https://jonaspvean.github.io/blog/2024/fixing-quartz-emit-issue/"> <script src="/assets/js/theme.js?2030bb0ee46b414e305a934659ce22ae"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Jonas</span> Pedersen Vean </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/notes/public/">research notes </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Fixing the Quartz Emit Issue</h1> <p class="post-meta"> Created in September 20, 2024 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/frontend"> <i class="fa-solid fa-hashtag fa-sm"></i> frontend</a>   <a href="/blog/tag/blog-meta"> <i class="fa-solid fa-hashtag fa-sm"></i> blog-meta</a>     ·   <a href="/blog/category/programming"> <i class="fa-solid fa-tag fa-sm"></i> programming</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="working-as-intended">Working as intended</h2> <p>After having “completed” the merge of al-folio with Quartz (see <a href="/blog/2024/how-this-site-was-made">this</a> blog post), I genuinely hoped that would be the end of trying to reconcile the two different architectures together. Alas, I would not be so lucky. Turns out there was an issue where if you navigated outside of the Quartz scope, i.e. the <code class="language-plaintext highlighter-rouge">/notes/public</code> subdirectory, then the resource files that Quartz emits into the root <code class="language-plaintext highlighter-rouge">&lt;html&gt;</code> and <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> environments would carry over to the al-folio part of the website. This would cause some of the themed parts of the website to break, along with some of the otherwise loaded inline JavaScript files to throw errors.</p> <h2 id="how-quartz-emits-files">How Quartz emits files</h2> <p>In order for a website to have anything beyond the most basic functionality, it has to load scripts and utility resources for plugins, buttons, etc. Usually, these scripts are JavaScript files with a <code class="language-plaintext highlighter-rouge">.js</code> extension. The way that Quartz 4.0 makes sure that the required files are included in the HTML document is through emitting the resource files in conjunction with the loading process of the DOM (Document Object Model), which is an inherent, object-oriented representation of the web page itself. So, before the site is loaded, Quartz emits the resources of every component with a non-empty <code class="language-plaintext highlighter-rouge">beforeDOMLoaded</code> property into a script called <code class="language-plaintext highlighter-rouge">prescript.js</code>, which is then placed in the <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> part of the document. These components have functionality that is deemed essential for the pages generated by Quartz to properly load. Similarly, the components with less-than-essential functionality with non-empty <code class="language-plaintext highlighter-rouge">afterDOMLoaded</code> property are all loaded into a script called <code class="language-plaintext highlighter-rouge">postscript.js</code>. Quartz also emits other script and resource files that get pushed through <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> upon navigation, as well as prepending the <code class="language-plaintext highlighter-rouge">index.css</code> required for styling. For reference, the postscript is not included in the <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code>.</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/head_env_screenshot-480.webp 480w,/assets/img/head_env_screenshot-800.webp 800w,/assets/img/head_env_screenshot-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/head_env_screenshot.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Excerpt from the HTML element display of the head environment when viewing Quartz. </div> <p><br></p> <h2 id="a-heuristic-observation">A heuristic observation</h2> <p>Now, a naïve and short-lived fix for this was simply to refresh the pages upon breaking. However, this requires a user-end action that is rather cumbersome and wouldn’t cut it in the long run. One day, I was messing about with the site trying to figure out exactly how the emit functionality of Quartz really worked, and so I tried to reduce the analysis to a minimal working example. What was the simplest possible page in Quartz which still emitted files to <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code>? After some thinking and searching, combing through files and whatnot, I discovered that Quartz’ 404 page was rather simple, and even more interestingly has its own <code class="language-plaintext highlighter-rouge">.tsx</code> defined page component. So I thought “okay, let’s see what the 404 page emits and how we can manipulate its emissions!”, fully expecting that I would need to understand and change the behaviour of the emit mechanism. When I attempted to test this, what greeted me was not the Quartz 404 as I was expecting but rather the al-folio 404 page. Of course! Since Quartz is running as a subfolder of the al-folio hierarchy, the 404 page is relegated to al-folio! I felt silly for a moment, however I then realized that the emitted files from Quartz were gone from the <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> environment of the 404 page. That is when I found the one line which would point me in the right direction:</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/highlighted_line-480.webp 480w,/assets/img/highlighted_line-800.webp 800w,/assets/img/highlighted_line-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/highlighted_line.png" class="img-fluid rounded z-depth-1 small-centered" width="100%" height="auto" loading="lazy" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> Voilà. The highlighted line was the silver bullet to solve my problems. From the default.liquid file, al-folio. </div> <p>Turns out that the redirect script on al-folio’s end uses a redirect script that works as a refresh, except without the flash of a white frame inbetween! After three seconds on the 404 page you get sent to the home page (in this case the <a href="/">about</a> page) via a seamless redirect. In fact, you could just add that line into the <code class="language-plaintext highlighter-rouge">&lt;head&gt;</code> environment of any document, change the redirect url from the home page to the currently viewed page itself, and set the content refresh timer to 0. This results in a near instant, seamless reload of the given page! Using this idea, I wrote a little TypeScript file that checks whether the user navigates out of the Quartz scope, and if so instantly refreshes the page in question:</p> <div class="language-tsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">isOutOfQuartz</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// this function catches whether the current page is out of the Quartz environment </span>
    <span class="c1">// given that it isn't locally hosted</span>
    <span class="kd">const</span> <span class="na">isInQuartz</span><span class="p">:</span> <span class="nx">boolean</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">notes/public</span><span class="dl">"</span><span class="p">)</span> <span class="o">!=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="kd">const</span> <span class="na">isLocallyHosted</span><span class="p">:</span> <span class="nx">boolean</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">"</span><span class="s2">localhost</span><span class="dl">"</span><span class="p">)</span> <span class="o">!=-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">if </span><span class="p">(</span><span class="nx">isLocallyHosted</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">isOutOfQuartz status: site is locally hosted</span><span class="dl">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">isLocallyHosted</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isInQuartz</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">instantPageRedirect</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// redirects a page into itself instantaneously so as to refresh it and remove emitted </span>
    <span class="c1">// files from the Quartz environment</span>
    <span class="k">if </span><span class="p">(</span><span class="nf">isOutOfQuartz</span><span class="p">())</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span>
        <span class="kd">var</span> <span class="nx">metaElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">createElement</span><span class="p">(</span><span class="dl">'</span><span class="s1">meta</span><span class="dl">'</span><span class="p">)</span>
        <span class="nx">metaElement</span><span class="p">.</span><span class="nx">httpEquiv</span><span class="o">=</span><span class="dl">"</span><span class="s2">refresh</span><span class="dl">"</span>
        <span class="nx">metaElement</span><span class="p">.</span><span class="nx">content</span><span class="o">=</span><span class="s2">`0; url = </span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">head</span><span class="p">.</span><span class="nf">appendChild</span><span class="p">(</span><span class="nx">metaElement</span><span class="p">)</span>
        <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">metaElement</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nb">document</span><span class="p">.</span><span class="nf">addEventListener</span><span class="p">(</span><span class="dl">"</span><span class="s2">nav</span><span class="dl">"</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// once we trigger a navigation, we check if an instant reload is needed</span>
    <span class="nf">instantPageRedirect</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div></div> <p>This worked! The check for whether the page is locally hosted is there so that when the site is built and tested locally the website refrains from updating all the time. This concludes our excursion into yet another bout of troubleshooting.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/how-this-site-was-made/">How This Site Came to Be</a> </li> </div> </div> <footer class="sticky-bottom mt-5" role="contentinfo"> <div class="container"> © Copyright 2024 Jonas Pedersen Vean. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with a modified <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?b7816bd189846d29eded8745f9c4cf77"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.min.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>