---
layout: post
title: Fixing the Quartz Emit Issue
date: 2024-09-20
description: The joys and power of a makeshift solution
tags: frontend blog-meta
categories: programming
---

## Working as intended
After having "completed" the merge of al-folio with Quartz (see [this](/blog/2024/how-this-site-was-made) blog post), I genuinely hoped that would be the end of trying to reconcile the two different architectures together. Alas, I would not be so lucky. Turns out there was an issue where if you navigated outside of the Quartz scope, i.e. the `/notes/public` subdirectory, then the resource files that Quartz emits into the root `<html>` and `<head>` environments would carry over to the al-folio part of the website. This would cause some of the themed parts of the website to break, along with some of the otherwise loaded inline JavaScript files to throw errors. 

## How Quartz emits files
In order for a website to have anything beyond the most basic functionality, it has to load scripts and utility resources for plugins, buttons, etc. Usually, these scripts are JavaScript files with a `.js` extension. The way that Quartz 4.0 makes sure that the required files are included in the HTML document is through emitting the resource files in conjunction with the loading process of the DOM (Document Object Model), which is an inherent, object-oriented representation of the web page itself. So, before the site is loaded, Quartz emits the resources of every component with a non-empty `beforeDOMLoaded` property into a script called `prescript.js`, which is then placed in the `<head>` part of the document. These components have functionality that is deemed essential for the pages generated by Quartz to properly load. Similarly, the components with less-than-essential functionality with non-empty `afterDOMLoaded` property are all loaded into a script called `postscript.js`. Quartz also emits other script and resource files that get pushed through `<head>` upon navigation, as well as prepending the `index.css` required for styling. For reference, the postscript is not included in the `<head>`. 

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid path="assets/img/head_env_screenshot.png" class="img-fluid rounded z-depth-1" %}
    </div>
</div>
<div class="caption">
    Excerpt from the HTML element display of the head environment when viewing Quartz.   
</div>

<br>

## A heuristic observation
Now, a naïve and short-lived fix for this was simply to refresh the pages upon breaking. However, this requires a user-end action that is rather cumbersome and wouldn't cut it in the long run. One day, I was messing about with the site trying to figure out exactly how the emit functionality of Quartz really worked, and so I tried to reduce the analysis to a minimal working example. What was the simplest possible page in Quartz which still emitted files to `<head>`? After some thinking and searching, combing through files and whatnot, I discovered that Quartz' 404 page was rather simple, and even more interestingly has its own `.tsx` defined page component. So I thought "okay, let's see what the 404 page emits and how we can manipulate its emissions!", fully expecting that I would need to understand and change the behaviour of the emit mechanism. When I attempted to test this, what greeted me was not the Quartz 404 as I was expecting but rather the al-folio 404 page. Of course! Since Quartz is running as a subfolder of the al-folio hierarchy, the 404 page is relegated to al-folio! I felt silly for a moment, however I then realized that the emitted files from Quartz were gone from the `<head>` environment of the 404 page. That is when I found the one line which would point me in the right direction:

<div class="row mt-3">
    <div class="col-sm mt-3 mt-md-0">
        {% include figure.liquid path="assets/img/highlighted_line.png" class="img-fluid rounded z-depth-1 small-centered" %}
    </div>
</div>
<div class="caption">
    Voilà. The highlighted line was the silver bullet to solve my problems. From the default.liquid file, al-folio. 
</div>

Turns out that the redirect script on al-folio's end uses a redirect script that works as a refresh, except without the flash of a white frame inbetween! After three seconds on the 404 page you get sent to the home page (in this case the [about](/) page) via a seamless redirect. In fact, you could just add that line into the `<head>` environment of any document, change the redirect url from the home page to the currently viewed page itself, and set the content refresh timer to 0. This results in a near instant, seamless reload of the given page! Using this idea, I wrote a little TypeScript file that checks whether the user navigates out of the Quartz scope, and if so instantly refreshes the page in question:

```tsx
const isOutOfQuartz = () => {
    // this function catches whether the current page is out of the Quartz environment 
    // given that it isn't locally hosted
    const isInQuartz: boolean = (window.location.href.indexOf("notes/public") !=-1)
    const isLocallyHosted: boolean = (window.location.href.indexOf("localhost") !=-1)
    
    if (isLocallyHosted) {
        console.log("isOutOfQuartz status: site is locally hosted")
        return false
    }
    else if (!isLocallyHosted && !isInQuartz) {
        return true
    }
    else {
        return false
    }
}

const instantPageRedirect = () => {
    // redirects a page into itself instantaneously so as to refresh it and remove emitted 
    // files from the Quartz environment
    if (isOutOfQuartz()) {
        const url = window.location.href
        var metaElement = document.createElement('meta')
        metaElement.httpEquiv="refresh"
        metaElement.content=`0; url = ${url}`
        document.head.appendChild(metaElement)
        console.log(metaElement)
    }
}

document.addEventListener("nav", () => {
    // once we trigger a navigation, we check if an instant reload is needed
    instantPageRedirect()
})
```

This worked! The check for whether the page is locally hosted is there so that when the site is built and tested locally the website refrains from updating all the time. This concludes our excursion into yet another bout of troubleshooting. 

